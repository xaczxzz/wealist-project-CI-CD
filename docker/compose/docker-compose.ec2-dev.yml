# =============================================================================
# weAlist Project - EC2 Dev Environment (All-in-One)
# =============================================================================
# EC2 단일 인스턴스에서 모든 서비스를 실행하기 위한 통합 구성입니다.
# User Service, Board Service, Frontend, PostgreSQL, Redis, Monitoring 포함
#
# 사용법:
#   1. 환경 변수 파일 생성:
#      cp docker/env/.env.ec2-dev.example docker/env/.env.ec2-dev
#      vi docker/env/.env.ec2-dev  # OAuth 등 필수 값 입력
#
#   2. 서비스 시작:
#      docker compose --env-file docker/env/.env.ec2-dev \
#        -f docker/compose/docker-compose.ec2-dev.yml up -d
#
#   3. 로그 확인:
#      docker compose -f docker/compose/docker-compose.ec2-dev.yml logs -f
#
# 특징:
#   - 모든 포트 외부 노출 (테스트 편의성)
#   - 모니터링 스택 포함 (Prometheus, Grafana)
#   - 리소스 제한 설정 (t3.medium 기준)
# =============================================================================

services:
  # ===========================================================================
  # Backend Services
  # ===========================================================================

  # User Service (Spring Boot)
  user-service:
    build:
      context: ../../user-service
      dockerfile: Dockerfile
      args:
        CACHEBUST: ${CACHEBUST:-1}
    image: wealist/user-service:${VERSION:-latest}
    container_name: wealist-user-service
    hostname: user-service

    environment:
      # Server Configuration
      - SERVER_PORT=8080
      - USER_SERVICE_PORT=8080
      - APP_NAME=${APP_NAME:-wealist-api}

      # Database Configuration
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/${USER_DB_NAME}
      - SPRING_DATASOURCE_USERNAME=${USER_DB_USER}
      - SPRING_DATASOURCE_PASSWORD=${USER_DB_PASSWORD}
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=org.postgresql.Driver

      # JPA/Hibernate Configuration
      - SPRING_JPA_HIBERNATE_DDL_AUTO=${JPA_DDL_AUTO:-update}
      - SPRING_JPA_SHOW_SQL=${JPA_SHOW_SQL:-true}
      - SPRING_JPA_PROPERTIES_HIBERNATE_FORMAT_SQL=${JPA_FORMAT_SQL:-true}
      - SPRING_JPA_DATABASE_PLATFORM=org.hibernate.dialect.PostgreSQLDialect

      # Redis Configuration
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
      - SPRING_REDIS_PASSWORD=${REDIS_PASSWORD}
      - SPRING_REDIS_DATABASE=0

      # JWT Configuration
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ACCESS_TOKEN_EXPIRATION_MS=${JWT_ACCESS_TOKEN_EXPIRATION_MS:-1800000}
      - JWT_REFRESH_TOKEN_EXPIRATION_MS=${JWT_REFRESH_TOKEN_EXPIRATION_MS:-604800000}

      # OAuth Configuration
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}

      # Java Options (메모리 최적화 - Dev 환경)
      - JAVA_OPTS=-Xms128m -Xmx384m -XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0

    ports:
      - "${USER_HOST_PORT:-8080}:8080"

    networks:
      - wealist-net

    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

    restart: unless-stopped

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # 리소스 제한 (t3.small 최적화: 2 vCPU, 2GB RAM)
    deploy:
      resources:
        limits:
          cpus: '0.6'
          memory: 512M
        reservations:
          cpus: '0.3'
          memory: 256M

  # Board Service (Go)
  board-service:
    build:
      context: ../../board-service
      dockerfile: docker/Dockerfile
    image: wealist/board-service:${VERSION:-latest}
    container_name: wealist-board-service
    hostname: board-service

    environment:
      # Server Configuration
      - ENV=dev
      - BOARD_SERVER_PORT=8000
      - LOG_LEVEL=${LOG_LEVEL:-debug}

      # Database Configuration
      - DATABASE_URL=postgresql://${BOARD_DB_USER}:${BOARD_DB_PASSWORD}@postgres:5432/${BOARD_DB_NAME}?sslmode=disable

      # Redis Configuration
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/1

      # JWT Configuration (User Service와 동일해야 함!)
      - SECRET_KEY=${JWT_SECRET}

      # Service URLs
      - USER_SERVICE_URL=http://user-service:8080

      # CORS Configuration
      - CORS_ORIGINS=${CORS_ORIGINS:-*}

    ports:
      - "${BOARD_HOST_PORT:-8000}:8000"

    networks:
      - wealist-net

    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      user-service:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    restart: unless-stopped

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # 리소스 제한 (t3.small 최적화)
    deploy:
      resources:
        limits:
          cpus: '0.4'
          memory: 256M
        reservations:
          cpus: '0.2'
          memory: 128M

  # ===========================================================================
  # Infrastructure Services
  # ===========================================================================
  # Note: Frontend는 S3에 별도 배포되므로 여기에 포함하지 않음

  # PostgreSQL Database
  postgres:
    image: postgres:17-alpine
    container_name: wealist-postgres
    hostname: postgres

    environment:
      - POSTGRES_USER=${POSTGRES_SUPERUSER}
      - POSTGRES_PASSWORD=${POSTGRES_SUPERUSER_PASSWORD}
      - POSTGRES_INITDB_ARGS=--locale-provider=icu --icu-locale=en-US
      - USER_DB_NAME=${USER_DB_NAME}
      - USER_DB_USER=${USER_DB_USER}
      - USER_DB_PASSWORD=${USER_DB_PASSWORD}
      - BOARD_DB_NAME=${BOARD_DB_NAME}
      - BOARD_DB_USER=${BOARD_DB_USER}
      - BOARD_DB_PASSWORD=${BOARD_DB_PASSWORD}
      - PGDATA=/var/lib/postgresql/data/pgdata

    ports:
      - "${POSTGRES_HOST_PORT:-5432}:5432"

    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ../../docker/init/postgres/init-db.sh:/docker-entrypoint-initdb.d/init-db.sh:ro

    networks:
      - wealist-net

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_SUPERUSER} -d postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    restart: unless-stopped

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Security: Run as non-root user
    user: postgres

    # 리소스 제한 (t3.small 최적화)
    deploy:
      resources:
        limits:
          cpus: '0.4'
          memory: 384M
        reservations:
          cpus: '0.2'
          memory: 256M

  # Redis Cache
  redis:
    image: redis:7.2-alpine
    container_name: wealist-redis
    hostname: redis

    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --databases 16
      --maxmemory 128mb
      --maxmemory-policy allkeys-lru
      --save 60 1000
      --appendonly yes
      --appendfsync everysec

    ports:
      - "${REDIS_HOST_PORT:-6379}:6379"

    volumes:
      - redis-data:/data

    networks:
      - wealist-net

    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s

    restart: unless-stopped

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # 리소스 제한 (t3.small 최적화)
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M

  # ===========================================================================
  # Monitoring Services
  # ===========================================================================

  # Prometheus - Metrics Collection
  prometheus:
    image: prom/prometheus:latest
    container_name: wealist-prometheus
    hostname: prometheus

    user: "0:0"

    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
      - '--storage.tsdb.retention.time=15d'

    volumes:
      - ../../prometheus/config:/etc/prometheus:ro
      - prometheus-data:/prometheus

    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"

    networks:
      - wealist-net

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # 리소스 제한 (t3.small 최적화)
    deploy:
      resources:
        limits:
          cpus: '0.3'
          memory: 256M
        reservations:
          cpus: '0.15'
          memory: 128M

  # Grafana - Visualization
  grafana:
    image: grafana/grafana:latest
    container_name: wealist-grafana
    hostname: grafana

    user: "0:0"

    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=http://localhost:${GRAFANA_PORT:-3001}
      - GF_INSTALL_PLUGINS=redis-datasource

    volumes:
      - grafana-storage:/var/lib/grafana
      - grafana-logs:/var/log/grafana

    ports:
      - "${GRAFANA_PORT:-3001}:3000"

    networks:
      - wealist-net

    depends_on:
      - prometheus

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # 리소스 제한 (t3.small 최적화)
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 64M

  # ===========================================================================
  # Exporters
  # ===========================================================================

  # Redis Exporter
  redis-exporter:
    image: oliver006/redis_exporter:latest
    container_name: wealist-redis-exporter
    hostname: redis-exporter

    environment:
      - REDIS_ADDR=redis:6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_EXPORTER_DEBUG=false

    ports:
      - "${REDIS_EXPORTER_PORT:-9121}:9121"

    networks:
      - wealist-net

    depends_on:
      - redis

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9121/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # 리소스 제한 (t3.small 최적화)
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 64M
        reservations:
          cpus: '0.05'
          memory: 32M

  # PostgreSQL Exporter
  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: wealist-postgres-exporter
    hostname: postgres-exporter

    environment:
      - DATA_SOURCE_NAME=postgresql://${POSTGRES_SUPERUSER}:${POSTGRES_SUPERUSER_PASSWORD}@postgres:5432/postgres?sslmode=disable

    ports:
      - "${POSTGRES_EXPORTER_PORT:-9187}:9187"

    networks:
      - wealist-net

    depends_on:
      postgres:
        condition: service_healthy

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9187/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # 리소스 제한 (t3.small 최적화)
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 64M
        reservations:
          cpus: '0.05'
          memory: 32M

  # Node Exporter (호스트 메트릭 수집)
  node-exporter:
    image: prom/node-exporter:latest
    container_name: wealist-node-exporter
    hostname: node-exporter

    command:
      - '--path.rootfs=/host'
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'

    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro

    ports:
      - "${NODE_EXPORTER_PORT:-9100}:9100"

    networks:
      - wealist-net

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9100/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # 리소스 제한 (t3.small 최적화)
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 64M
        reservations:
          cpus: '0.05'
          memory: 32M

# =============================================================================
# Networks
# =============================================================================
networks:
  # 단일 네트워크 사용 (EC2 Dev 환경 단순화)
  wealist-net:
    driver: bridge
    name: wealist-ec2-dev-net

# =============================================================================
# Volumes
# =============================================================================
volumes:
  postgres-data:
    name: wealist-ec2-postgres-data
    driver: local

  redis-data:
    name: wealist-ec2-redis-data
    driver: local

  prometheus-data:
    name: wealist-ec2-prometheus-data
    driver: local

  grafana-storage:
    name: wealist-ec2-grafana-storage
    driver: local

  grafana-logs:
    name: wealist-ec2-grafana-logs
    driver: local