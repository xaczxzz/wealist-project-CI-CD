name: Backend EC2 Continuous Deployment

on:
  # User/Board Service CI ì›Œí¬í”Œë¡œìš° ì„±ê³µ ì‹œ íŠ¸ë¦¬ê±°
  workflow_run:
    workflows: ["User Service CI/CD", "Board Service CI/CD"] # CI ì›Œí¬í”Œë¡œìš° ì´ë¦„ ì§€ì •
    types:
      - completed
    branches:
      - main # main ë¸Œëœì¹˜ì—ì„œ CIê°€ ì„±ê³µí–ˆì„ ë•Œë§Œ CD ì‹¤í–‰

jobs:
  deploy_to_ec2:
    # CI ì›Œí¬í”Œë¡œìš°ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆì„ ë•Œë§Œ ì‹¤í–‰
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    environment: development # GitHub í™˜ê²½ ì„¤ì • (Secrets ê´€ë¦¬ ìš©ì´)

    steps:
      - name: â¬‡ï¸ Checkout Monorepo Code
        uses: actions/checkout@v4
        # EC2ì— ì „ì†¡í•  Docker Compose íŒŒì¼ ë° dev.sh ìŠ¤í¬ë¦½íŠ¸ í™•ë³´

      # 1. Terraform Output ê°€ì ¸ì˜¤ê¸° (EC2 Public IP í™•ë³´)
      # - ì¸í”„ë¼ êµ¬ì¶• í›„ Outputs íŒŒì¼ì´ ìƒì„±ë˜ì–´ ìˆì–´ì•¼ í•¨
      - name: ğŸ–¥ï¸ Get EC2 Public IP from Terraform Output
        id: terraform_output
        uses: hashicorp/terraform-github-actions/github-action@v2
        with:
          tf_actions_state: ${{ secrets.TF_STATE_CONTENT }} # (ì„ íƒ) ìƒíƒœ íŒŒì¼ ì§ì ‘ ì „ë‹¬
          tf_actions_state_backend_config: |
            bucket = "wealist-terraform-state-dev"
            key = "dev/wealist.tfstate"
            region = "ap-northeast-2"
          tf_actions_subcommand: "output"

      - name: ğŸ¯ Set EC2_HOST Variable
        id: set_host
        run: echo "EC2_HOST=$(echo '${{ steps.terraform_output.outputs.ec2_public_ip }}')" >> $GITHUB_ENV
        # Outputsì—ì„œ IP ì£¼ì†Œë¥¼ ê°€ì ¸ì™€ í™˜ê²½ ë³€ìˆ˜ì— ì €ì¥

      # 2. SSH ì ‘ì† í‚¤ ì„¤ì •
      - name: ğŸ”‘ Setup SSH Private Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          # EC2 ì ‘ì†ìš© í”„ë¼ì´ë¹— í‚¤ (GitHub Secretsì— ì €ì¥)

      # 3. EC2 ì ‘ì† ë° ë°°í¬ ëª…ë ¹ ì‹¤í–‰ (CD í•µì‹¬)
      - name: ğŸš€ Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.EC2_HOST }}
          username: ec2-user # Amazon Linux ê¸°ë³¸ ì‚¬ìš©ì
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          script: |
            # 1. EC2 ì„œë²„ ì¤€ë¹„ (Docker Compose íŒŒì¼ í™•ë³´)
            APP_DIR="/home/ec2-user/wealist-project"
            if [ ! -d "$APP_DIR" ]; then
              echo "Cloning repository..."
              git clone https://github.com/your-repo/wealist-project.git "$APP_DIR"
            fi
            cd "$APP_DIR"
            git pull # ìµœì‹  Docker Compose íŒŒì¼ ë° ìŠ¤í¬ë¦½íŠ¸ í™•ë³´

            # 2. í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„±/ì—…ë°ì´íŠ¸ (Secretsì—ì„œ ì£¼ì… í•„ìš”)
            # AWS Secrets Managerë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ, í™˜ê²½ë³€ìˆ˜ íŒŒì¼ì„ ì—¬ê¸°ì„œ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.
            # ì´ ë‹¨ê³„ëŠ” ë¯¼ê° ì •ë³´ ê´€ë¦¬ê°€ í•„ìš”í•˜ì—¬ ì¶”í›„ Secrets Manager ì‚¬ìš©ì„ ê¶Œì¥í•©ë‹ˆë‹¤.

            # (ì„ì‹œ) CI í™˜ê²½ ë³€ìˆ˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ .env.dev íŒŒì¼ì„ ìƒì„±/ì—…ë°ì´íŠ¸í•œë‹¤ê³  ê°€ì •
            cp docker/env/.env.dev.example docker/env/.env.dev
            # ì‹¤ì œ ê°’ì€ Secretsì—ì„œ ê°€ì ¸ì™€ sed ë“±ìœ¼ë¡œ ì¹˜í™˜í•´ì•¼ í•¨

            # 3. ìµœì‹  ì´ë¯¸ì§€ Pull ë° ì„œë¹„ìŠ¤ ì¬ì‹œì‘
            # ê¸°ì¡´ì— ì •ì˜ëœ dev.sh ìŠ¤í¬ë¦½íŠ¸ì˜ pull/update ëª…ë ¹ì„ í™œìš©í•˜ì—¬ ì¬ì‚¬ìš©ì„± ê·¹ëŒ€í™”
            ./docker/scripts/dev.sh pull # dev.shì— pull ëª…ë ¹ ì¶”ê°€ê°€ í•„ìš”í•©ë‹ˆë‹¤.

            # í˜„ì¬ dev.shì— pullì´ ì—†ìœ¼ë¯€ë¡œ ì§ì ‘ ëª…ë ¹ ì‹¤í–‰ (prod.sh update ì°¸ê³ )
            COMPOSE_FILES="-f docker/compose/docker-compose.yml -f docker/compose/docker-compose.dev.yml"
            ENV_FILE="docker/env/.env.dev"
            ENV_FILE_OPTION="--env-file $ENV_FILE"

            echo "Pulling latest images..."
            docker compose $ENV_FILE_OPTION $COMPOSE_FILES pull user-service board-service postgres redis

            echo "Restarting services for deployment..."
            docker compose $ENV_FILE_OPTION $COMPOSE_FILES up -d --remove-orphans --no-build
            echo "Deployment complete."
