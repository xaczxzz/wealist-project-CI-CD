name: Board Service CI/CD

on:
  push:
    branches: [main, develop]
    paths:
      - "board-service/**" # Board Service í´ë” ë³€ê²½ ì‹œì—ë§Œ ì‹¤í–‰
      - ".github/workflows/ci/board-service-ci.yml"
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ì˜µì…˜

jobs:
  build_and_push:
    name: Build & Push Board Service Image
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout Monorepo Code
        uses: actions/checkout@v4

      # 1. Go í™˜ê²½ ì„¤ì •
      - name: âš™ï¸ Setup Go Environment
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"
          cache: true # ì˜ì¡´ì„± ìºì‹± (Go Modules)

      # 2. Go Module ë‹¤ìš´ë¡œë“œ (ì˜ì¡´ì„± ì„¤ì¹˜)
      - name: ğŸ“¦ Go Mod Tidy & Download
        run: |
          cd board-service
          go mod tidy
          go mod download

      # 3. í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ìœ ë‹› í…ŒìŠ¤íŠ¸)
      - name: ğŸ§ª Run Unit Tests
        run: |
          cd board-service
          # ëª¨ë“  í…ŒìŠ¤íŠ¸ íŒŒì¼ ì‹¤í–‰. ì‹¤íŒ¨ ì‹œ ì›Œí¬í”Œë¡œìš° ì¤‘ë‹¨.
          go test ./... -v

      # 4. ë°”ì´ë„ˆë¦¬ ë¹Œë“œ (CI í™˜ê²½ì—ì„œ)
      - name: ğŸ”¨ Build Go Binary
        run: |
          cd board-service
          # ë°”ì´ë„ˆë¦¬ë¥¼ 'board-service-app' ì´ë¦„ìœ¼ë¡œ ìƒì„± (Dockerì—ì„œ ì‚¬ìš©)
          CGO_ENABLED=0 GOOS=linux go build -o board-service-app . 
          # CGO_ENABLED=0, GOOS=linuxëŠ” í¬ë¡œìŠ¤ ì»´íŒŒì¼ ë° ê²½ëŸ‰í™”(Scratch Image)ì— í•„ìˆ˜ì…ë‹ˆë‹¤.

      # 5. Docker ë¡œê·¸ì¸ (Secret ì‚¬ìš©)
      - name: ğŸ”‘ Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 6. ì´ë¯¸ì§€ íƒœê·¸ ì •ì˜ (User Serviceì™€ ë™ì¼í•œ ì „ëµ)
      - name: ğŸ·ï¸ Define Image Tags
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/board-service
          tags: |
            type=sha,format=long 
            type=raw,value=
