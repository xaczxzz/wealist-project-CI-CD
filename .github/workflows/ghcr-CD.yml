name: Deploy to EC2

on:
  workflow_run:
    workflows: ["Build and Push Docker Images to GHCR (EC2 Dev)"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Copy Docker Compose files to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          source: "docker/compose/docker-compose.ec2-dev.yml,docker/env/.env.ec2-dev.example"
          target: "/home/ec2-user/wealist-deploy/"
          strip_components: 2  # docker/compose/ ë¶€ë¶„ ì œê±°

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸš€ Starting deployment..."
            
            # í•„ìˆ˜ ë„êµ¬ ì„¤ì¹˜ í™•ì¸
            if ! command -v docker &> /dev/null; then
              echo "Installing Docker..."
              sudo yum update -y
              sudo yum install -y docker
              sudo systemctl start docker
              sudo systemctl enable docker
              sudo usermod -a -G docker ec2-user
            fi
            
            if ! command -v docker-compose &> /dev/null; then
              echo "Installing Docker Compose..."
              sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
            fi
            
            # Docker ì„œë¹„ìŠ¤ ì‹œì‘
            sudo systemctl start docker
            
            # ë°°í¬ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /home/ec2-user/wealist-deploy
            
            echo "âš™ï¸ Creating environment configuration..."
            
            # .env íŒŒì¼ ìƒì„± (ê¸°ì¡´ .env.ec2-dev.example ê¸°ë°˜)
            cat > .env.ec2-dev << 'EOF'
            # GHCR Configuration
            GITHUB_REPOSITORY_OWNER=${{ github.repository_owner }}
            GITHUB_REPOSITORY_NAME=wealist-project-ci-cd
            USER_SERVICE_VERSION=${{ github.sha }}
            BOARD_SERVICE_VERSION=${{ github.sha }}
            
            # Database Configuration
            POSTGRES_SUPERUSER=postgres
            POSTGRES_SUPERUSER_PASSWORD=${{ secrets.DATABASE_PASSWORD }}
            USER_DB_NAME=wealist_user_dev
            USER_DB_USER=wealist_user
            USER_DB_PASSWORD=${{ secrets.DATABASE_PASSWORD }}
            BOARD_DB_NAME=wealist_board_dev
            BOARD_DB_USER=wealist_board
            BOARD_DB_PASSWORD=${{ secrets.DATABASE_PASSWORD }}
            
            # Application Secrets
            DATABASE_PASSWORD=${{ secrets.DATABASE_PASSWORD }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
            
            # Monitoring
            GRAFANA_ADMIN_USER=admin
            GRAFANA_ADMIN_PASSWORD=${{ secrets.GRAFANA_ADMIN_PASSWORD }}
            
            # Ports
            USER_HOST_PORT=8080
            BOARD_HOST_PORT=8000
            POSTGRES_HOST_PORT=5432
            REDIS_HOST_PORT=6379
            GRAFANA_PORT=3001
            PROMETHEUS_PORT=9090
            NODE_EXPORTER_PORT=9100
            REDIS_EXPORTER_PORT=9121
            POSTGRES_EXPORTER_PORT=9187
            
            # Application Configuration
            APP_NAME=wealist-api
            JPA_DDL_AUTO=update
            JPA_SHOW_SQL=false
            JPA_FORMAT_SQL=false
            CORS_ORIGINS=https://wealist.co.kr,http://localhost:3000
            LOG_LEVEL=info
            EOF
            
            # ìˆ˜ì •ëœ ë²„ì „
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io --username ${{ github.repository_owner }} --password-stdin
            if [ $? -eq 0 ]; then
              echo "âœ… GHCR login successful"
            else
            echo "âŒ GHCR login failed"
            exit 1
            fi  


            # ê¸°ì¡´ ì„œë¹„ìŠ¤ ì¤‘ì§€
            echo "ğŸ›‘ Stopping existing services..."
            docker-compose --env-file .env.ec2-dev -f docker-compose.ec2-dev.yml down || true
            
            # ìµœì‹  ì´ë¯¸ì§€ Pull
            echo "ğŸ“¦ Pulling latest images..."
            docker-compose --env-file .env.ec2-dev -f docker-compose.ec2-dev.yml pull
            
            # ì„œë¹„ìŠ¤ ì‹œì‘
            echo "ğŸ”„ Starting services..."
            docker-compose --env-file .env.ec2-dev -f docker-compose.ec2-dev.yml up -d --remove-orphans
            
            # í—¬ìŠ¤ì²´í¬ ëŒ€ê¸°
            echo "â³ Waiting for services to start..."
            sleep 60
            
            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo "ğŸ“Š Container Status:"
            docker-compose --env-file .env.ec2-dev -f docker-compose.ec2-dev.yml ps
            
            # í—¬ìŠ¤ì²´í¬
            echo "ğŸ¥ Health checking..."
            if curl -f -s http://localhost:8080/actuator/health > /dev/null 2>&1; then
              echo "âœ… User Service: Healthy"
            else
              echo "âŒ User Service: Unhealthy"
              echo "ğŸ“‹ User Service logs:"
              docker logs wealist-user-service --tail 20
            fi
            
            if curl -f -s http://localhost:8000/health > /dev/null 2>&1; then
              echo "âœ… Board Service: Healthy"
            else
              echo "âŒ Board Service: Unhealthy"
              echo "ğŸ“‹ Board Service logs:"
              docker logs wealist-board-service --tail 20
            fi
            
            # ì •ë¦¬
            echo "ğŸ§¹ Cleaning up unused images..."
            docker image prune -f
            
            echo "âœ… Deployment completed successfully!"
            echo "ğŸŒ Services available at:"
            echo "   - User Service: http://${{ secrets.EC2_HOST }}:8080"
            echo "   - Board Service: http://${{ secrets.EC2_HOST }}:8000"
            echo "   - Grafana: http://${{ secrets.EC2_HOST }}:3001"
            echo "   - Prometheus: http://${{ secrets.EC2_HOST }}:9090"