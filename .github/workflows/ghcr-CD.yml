name: Deploy to EC2

on:
  workflow_run:
    workflows: ["Build and Push Docker Images to GHCR (EC2 Dev)"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ec2-user
        key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        envs: |
          GITHUB_REPOSITORY_OWNER,
          USER_SERVICE_VERSION,
          BOARD_SERVICE_VERSION,
          DATABASE_PASSWORD,
          GOOGLE_CLIENT_SECRET,
          JWT_SECRET,
          REDIS_PASSWORD
        script: |
          echo "ðŸš€ Starting deployment..."
          
          # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd /home/ec2-user/wealist-project
          
          # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
          git pull origin main
          
          # í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„±
          cat > docker/env/.env.ec2-dev << EOF
          GITHUB_REPOSITORY_OWNER=${GITHUB_REPOSITORY_OWNER}
          USER_SERVICE_VERSION=${USER_SERVICE_VERSION}
          BOARD_SERVICE_VERSION=${BOARD_SERVICE_VERSION}
          DATABASE_PASSWORD=${DATABASE_PASSWORD}
          GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
          JWT_SECRET=${JWT_SECRET}
          REDIS_PASSWORD=${REDIS_PASSWORD}
          EOF
          
          # GHCR ë¡œê·¸ì¸
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # âœ… ì •í™•í•œ Docker Compose íŒŒì¼ë“¤ ì§€ì •
          COMPOSE_FILES="-f docker/compose/docker-compose.ec2-dev.yml"
          ENV_FILE="--env-file docker/env/.env.ec2-dev"
          
          # ê¸°ì¡´ ì„œë¹„ìŠ¤ ì¤‘ì§€
          echo "ðŸ›‘ Stopping existing services..."
          docker compose ${ENV_FILE} ${COMPOSE_FILES} down || true
          
          # ìµœì‹  ì´ë¯¸ì§€ Pull
          echo "ðŸ“¦ Pulling latest images..."
          docker compose ${ENV_FILE} ${COMPOSE_FILES} pull
          
          # ì„œë¹„ìŠ¤ ì‹œìž‘
          echo "ðŸ”„ Starting services..."
          docker compose ${ENV_FILE} ${COMPOSE_FILES} up -d --remove-orphans
          
          # í—¬ìŠ¤ì²´í¬
          echo "ðŸ¥ Health checking..."
          sleep 30
          docker compose ${ENV_FILE} ${COMPOSE_FILES} ps
          
          echo "âœ… Deployment completed!"
      env:
        GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        USER_SERVICE_VERSION: ${{ github.sha }}
        BOARD_SERVICE_VERSION: ${{ github.sha }}
        DATABASE_PASSWORD: ${{ secrets.DATABASE_PASSWORD }}
        GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}