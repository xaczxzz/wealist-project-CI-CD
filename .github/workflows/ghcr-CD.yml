name: Deploy to EC2

on:
  workflow_run:
    workflows: ["Build and Push Docker Images to GHCR (EC2 Dev)"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to EC2
        run: |
          echo "ğŸš€ Starting deployment..."
          
          # SSH í‚¤ ì„¤ì •
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/ec2_key
          chmod 600 ~/.ssh/ec2_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
          
          # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          ssh -i ~/.ssh/ec2_key ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
            echo "ğŸ”§ Setting up deployment environment..."
            
            # í•„ìˆ˜ ë„êµ¬ ì„¤ì¹˜ (Dockerë§Œ í•„ìš”)
            if ! command -v docker &> /dev/null; then
              echo "Installing Docker..."
              sudo yum update -y
              sudo yum install -y docker
              sudo systemctl start docker
              sudo systemctl enable docker
              sudo usermod -a -G docker ec2-user
            fi
            
            if ! command -v docker-compose &> /dev/null; then
              echo "Installing Docker Compose..."
              sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
            fi
            
            # Docker ì„œë¹„ìŠ¤ ì‹œì‘
            sudo systemctl start docker
            
            # ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p /home/ec2-user/wealist-deploy
            cd /home/ec2-user/wealist-deploy
            
            echo "âš™ï¸ Creating Docker Compose configuration..."
            
            # í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„±
            cat > .env << 'ENVEOF'
            # GHCR Configuration
            GITHUB_REPOSITORY_OWNER=${{ github.repository_owner }}
            GITHUB_REPOSITORY_NAME=wealist-project-ci-cd
            USER_SERVICE_VERSION=${{ github.sha }}
            BOARD_SERVICE_VERSION=${{ github.sha }}
            
            # Database Configuration
            POSTGRES_SUPERUSER=postgres
            POSTGRES_SUPERUSER_PASSWORD=${{ secrets.DATABASE_PASSWORD }}
            USER_DB_NAME=wealist_user_dev
            USER_DB_USER=wealist_user
            USER_DB_PASSWORD=${{ secrets.DATABASE_PASSWORD }}
            BOARD_DB_NAME=wealist_board_dev
            BOARD_DB_USER=wealist_board
            BOARD_DB_PASSWORD=${{ secrets.DATABASE_PASSWORD }}
            
            # Application Configuration
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
            
            # Ports
            USER_HOST_PORT=8080
            BOARD_HOST_PORT=8000
            POSTGRES_HOST_PORT=5432
            REDIS_HOST_PORT=6379
            GRAFANA_PORT=3001
            PROMETHEUS_PORT=9090
            
            # Other
            APP_NAME=wealist-api
            JPA_DDL_AUTO=update
            CORS_ORIGINS=https://wealist.co.kr,http://localhost:3000
            LOG_LEVEL=info
            ENVEOF
            
            # Docker Compose íŒŒì¼ ìƒì„±
            cat > docker-compose.yml << 'COMPOSEEOF'
            version: '3.8'
            
            services:
              # User Service
              user-service:
                image: ghcr.io/${GITHUB_REPOSITORY_OWNER}/${GITHUB_REPOSITORY_NAME}/wealist-user-service:${USER_SERVICE_VERSION}
                container_name: wealist-user-service
                hostname: user-service
                environment:
                  - SERVER_PORT=8080
                  - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/${USER_DB_NAME}
                  - SPRING_DATASOURCE_USERNAME=${USER_DB_USER}
                  - SPRING_DATASOURCE_PASSWORD=${USER_DB_PASSWORD}
                  - SPRING_JPA_HIBERNATE_DDL_AUTO=${JPA_DDL_AUTO:-update}
                  - SPRING_REDIS_HOST=redis
                  - SPRING_REDIS_PORT=6379
                  - SPRING_REDIS_PASSWORD=${REDIS_PASSWORD}
                  - JWT_SECRET=${JWT_SECRET}
                  - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
                  - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
                  - JAVA_OPTS=-Xms128m -Xmx384m
                ports:
                  - "${USER_HOST_PORT}:8080"
                depends_on:
                  postgres:
                    condition: service_healthy
                  redis:
                    condition: service_healthy
                networks:
                  - wealist-net
                restart: unless-stopped
            
              # Board Service
              board-service:
                image: ghcr.io/${GITHUB_REPOSITORY_OWNER}/${GITHUB_REPOSITORY_NAME}/wealist-board-service:${BOARD_SERVICE_VERSION}
                container_name: wealist-board-service
                hostname: board-service
                environment:
                  - ENV=dev
                  - BOARD_SERVER_PORT=8000
                  - DATABASE_URL=postgresql://${BOARD_DB_USER}:${BOARD_DB_PASSWORD}@postgres:5432/${BOARD_DB_NAME}?sslmode=disable
                  - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/1
                  - SECRET_KEY=${JWT_SECRET}
                  - USER_SERVICE_URL=http://user-service:8080
                ports:
                  - "${BOARD_HOST_PORT}:8000"
                depends_on:
                  postgres:
                    condition: service_healthy
                  redis:
                    condition: service_healthy
                  user-service:
                    condition: service_healthy
                networks:
                  - wealist-net
                restart: unless-stopped
            
              # PostgreSQL
              postgres:
                image: postgres:15-alpine
                container_name: wealist-postgres
                environment:
                  - POSTGRES_USER=${POSTGRES_SUPERUSER}
                  - POSTGRES_PASSWORD=${POSTGRES_SUPERUSER_PASSWORD}
                  - POSTGRES_INITDB_ARGS=--locale-provider=icu --icu-locale=en-US
                ports:
                  - "${POSTGRES_HOST_PORT}:5432"
                volumes:
                  - postgres_data:/var/lib/postgresql/data
                networks:
                  - wealist-net
                healthcheck:
                  test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_SUPERUSER}"]
                  interval: 10s
                  timeout: 5s
                  retries: 5
                restart: unless-stopped
            
              # Redis
              redis:
                image: redis:7.2-alpine
                container_name: wealist-redis
                command: redis-server --requirepass ${REDIS_PASSWORD}
                ports:
                  - "${REDIS_HOST_PORT}:6379"
                volumes:
                  - redis_data:/data
                networks:
                  - wealist-net
                healthcheck:
                  test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "${REDIS_PASSWORD}", "ping"]
                  interval: 10s
                  timeout: 3s
                  retries: 5
                restart: unless-stopped
            
              # Prometheus
              prometheus:
                image: prom/prometheus:latest
                container_name: wealist-prometheus
                ports:
                  - "${PROMETHEUS_PORT}:9090"
                volumes:
                  - prometheus_data:/prometheus
                networks:
                  - wealist-net
                restart: unless-stopped
            
              # Grafana
              grafana:
                image: grafana/grafana:latest
                container_name: wealist-grafana
                environment:
                  - GF_SECURITY_ADMIN_USER=admin
                  - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
                ports:
                  - "${GRAFANA_PORT}:3000"
                volumes:
                  - grafana_data:/var/lib/grafana
                networks:
                  - wealist-net
                restart: unless-stopped
            
            networks:
              wealist-net:
                driver: bridge
            
            volumes:
              postgres_data:
              redis_data:
              prometheus_data:
              grafana_data:
            COMPOSEEOF
            
            echo "ğŸ” Logging in to GHCR..."
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.repository_owner }} --password-stdin
            
            echo "ğŸ›‘ Stopping existing services..."
            docker-compose down || true
            
            echo "ğŸ“¦ Pulling latest images..."
            docker-compose pull
            
            echo "ğŸ”„ Starting services..."
            docker-compose up -d --remove-orphans
            
            echo "â³ Waiting for services to start..."
            sleep 45
            
            echo "ğŸ“Š Container Status:"
            docker-compose ps
            
            echo "ğŸ¥ Health checking..."
            if curl -f -s http://localhost:8080/actuator/health > /dev/null; then
              echo "âœ… User Service: Healthy"
            else
              echo "âŒ User Service: Unhealthy"
              docker logs wealist-user-service --tail 20
            fi
            
            if curl -f -s http://localhost:8000/health > /dev/null; then
              echo "âœ… Board Service: Healthy"
            else
              echo "âŒ Board Service: Unhealthy"  
              docker logs wealist-board-service --tail 20
            fi
            
            echo "ğŸ§¹ Cleaning up unused images..."
            docker image prune -f
            
            echo "âœ… Deployment completed!"
            echo "ğŸŒ Services available at:"
            echo "   - User Service: http://${{ secrets.EC2_HOST }}:8080"
            echo "   - Board Service: http://${{ secrets.EC2_HOST }}:8000"
            echo "   - Grafana: http://${{ secrets.EC2_HOST }}:3001"
            echo "   - Prometheus: http://${{ secrets.EC2_HOST }}:9090"
          EOF