name: Deploy to EC2

on:
  workflow_run:
    workflows: ["Build and Push Docker Images to GHCR (EC2 Dev)"]
    types: [completed]
    branches: [main]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
    inputs:
      image_tag:
        description: 'Docker image tag to deploy'
        required: false
        default: 'latest'
      force_pull:
        description: 'Force pull latest images'
        type: boolean
        default: true

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    # environment: development  # GitHub Environment ì‚¬ìš© (ì„ íƒì‚¬í•­)
    
    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸš€ Starting deployment..."
            
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /home/ec2-user/wealist-project
            
            # Gitì—ì„œ ìµœì‹  docker-compose íŒŒì¼ ê°€ì ¸ì˜¤ê¸°
            echo "ğŸ“¥ Pulling latest configuration..."
            git pull origin main
            
            # í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ë™ì  ìƒì„± (GitHub Secretsì—ì„œ ì£¼ì…)
            echo "âš™ï¸ Creating environment configuration..."
            cat > docker/env/.env.ec2-dev << 'EOF'
            # =============================================================================
            # GHCR Configuration
            # =============================================================================
            GITHUB_REPOSITORY_OWNER=${{ github.repository_owner }}
            GITHUB_REPOSITORY_NAME=${{ github.event.repository.name }}
            USER_SERVICE_VERSION=${{ github.sha }}
            BOARD_SERVICE_VERSION=${{ github.sha }}
            
            # =============================================================================
            # Application Configuration
            # =============================================================================
            APP_NAME=wealist-api
            VERSION=dev-${{ github.sha }}
            
            # =============================================================================
            # Database Configuration
            # =============================================================================
            POSTGRES_SUPERUSER=postgres
            POSTGRES_SUPERUSER_PASSWORD=${{ secrets.SUPERUSER_DATABASE_PASSWORD }}
            
            # User Service Database
            USER_DB_NAME=wealist_user_dev
            USER_DB_USER=wealist_user
            USER_DB_PASSWORD=${{ secrets.USER_DATABASE_PASSWORD }}
            
            # Board Service Database
            BOARD_DB_NAME=wealist_board_dev
            BOARD_DB_USER=wealist_board
            BOARD_DB_PASSWORD=${{ secrets.BOARD_DATABASE_PASSWORD }}
            
            # =============================================================================
            # Redis Configuration
            # =============================================================================
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
            
            # =============================================================================
            # JWT Configuration
            # =============================================================================
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            JWT_ACCESS_TOKEN_EXPIRATION_MS=1800000
            JWT_REFRESH_TOKEN_EXPIRATION_MS=604800000
            
            # =============================================================================
            # OAuth Configuration
            # =============================================================================
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            
            # =============================================================================
            # JPA Configuration
            # =============================================================================
            JPA_DDL_AUTO=update
            JPA_SHOW_SQL=false
            JPA_FORMAT_SQL=false
            
            # =============================================================================
            # CORS Configuration
            # =============================================================================
            CORS_ORIGINS=https://wealist.co.kr,https://www.wealist.co.kr,http://localhost:3000
            
            # =============================================================================
            # Monitoring Configuration
            # =============================================================================
            GRAFANA_ADMIN_USER=admin
            GRAFANA_ADMIN_PASSWORD=${{ secrets.GRAFANA_ADMIN_PASSWORD }}
            PROMETHEUS_PORT=9090
            GRAFANA_PORT=3001
            
            # =============================================================================
            # Port Configuration
            # =============================================================================
            USER_HOST_PORT=8080
            BOARD_HOST_PORT=8000
            POSTGRES_HOST_PORT=5432
            REDIS_HOST_PORT=6379
            NODE_EXPORTER_PORT=9100
            REDIS_EXPORTER_PORT=9121
            POSTGRES_EXPORTER_PORT=9187
            
            # =============================================================================
            # Logging Configuration
            # =============================================================================
            LOG_LEVEL=info
            EOF
            
             # GHCR ë¡œê·¸ì¸
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
      
            # âœ… ì •í™•í•œ Docker Compose íŒŒì¼ë“¤ ì§€ì •
            COMPOSE_FILES="-f docker/compose/docker-compose.ec2-dev.yml"
            ENV_FILE="--env-file docker/env/.env.ec2-dev"
            
            # ê¸°ì¡´ ì„œë¹„ìŠ¤ ì¤‘ì§€
            echo "ğŸ›‘ Stopping existing services..."
            docker compose ${ENV_FILE} ${COMPOSE_FILES} down || true
            
            # ìµœì‹  ì´ë¯¸ì§€ Pull
            echo "ğŸ“¦ Pulling latest images..."
            docker compose ${ENV_FILE} ${COMPOSE_FILES} pull
            
            # ì„œë¹„ìŠ¤ ì‹œì‘
            echo "ğŸ”„ Starting services..."
            docker compose ${ENV_FILE} ${COMPOSE_FILES} up -d --remove-orphans
            
            # í—¬ìŠ¤ì²´í¬
            echo "ğŸ¥ Health checking..."
            sleep 30
            docker compose ${ENV_FILE} ${COMPOSE_FILES} ps
            
            # User Service í—¬ìŠ¤ì²´í¬
            if curl -f -s http://localhost:8080/actuator/health > /dev/null; then
              echo "âœ… User Service: Healthy"
            else
              echo "âŒ User Service: Unhealthy"
              echo "ğŸ“‹ User Service logs:"
              docker logs wealist-user-service --tail 20
            fi
            
            # Board Service í—¬ìŠ¤ì²´í¬
            if curl -f -s http://localhost:8000/health > /dev/null; then
              echo "âœ… Board Service: Healthy"
            else
              echo "âŒ Board Service: Unhealthy"
              echo "ğŸ“‹ Board Service logs:"
              docker logs wealist-board-service --tail 20
            fi
            
            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo "ğŸ“Š Container Status:"
            docker compose --env-file docker/env/.env.ec2-dev \
              -f docker/compose/docker-compose.ec2-dev.yml ps
            
            # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬
            echo "ğŸ§¹ Cleaning up unused images..."
            docker image prune -f
            
            # ë°°í¬ ì™„ë£Œ ì •ë³´
            echo "âœ… Deployment completed successfully!"
            echo "ğŸŒ Services available at:"
            echo "   - User Service: http://${{ secrets.EC2_HOST }}:8080"
            echo "   - Board Service: http://${{ secrets.EC2_HOST }}:8000"
            echo "   - Grafana: http://${{ secrets.EC2_HOST }}:3001"
            echo "   - Prometheus: http://${{ secrets.EC2_HOST }}:9090"
      - name: Debug Secrets
        run: |
          echo "Checking secrets availability..."
          if [ -z "${{ secrets.EC2_HOST }}" ]; then
            echo "âŒ EC2_HOST is missing"
          else
            echo "âœ… EC2_HOST is available"
          fi
          
          if [ -z "${{ secrets.EC2_SSH_PRIVATE_KEY }}" ]; then
            echo "âŒ EC2_SSH_PRIVATE_KEY is missing"
          else
            echo "âœ… EC2_SSH_PRIVATE_KEY is available"
            echo "Key length: $(echo '${{ secrets.EC2_SSH_PRIVATE_KEY }}' | wc -c) characters"
          fi
      # ì„ íƒì‚¬í•­: ë°°í¬ ê²°ê³¼ë¥¼ Slackì´ë‚˜ Discordë¡œ ì•Œë¦¼
      - name: Notify Deployment Result
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment successful"
            # ì„±ê³µ ì•Œë¦¼ ë¡œì§
          else
            echo "âŒ Deployment failed" 
            # ì‹¤íŒ¨ ì•Œë¦¼ ë¡œì§
          fi
      